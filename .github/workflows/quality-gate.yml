name: quality-gate

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  shell-and-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Shell syntax + shellcheck
        run: |
          set -euo pipefail
          mapfile -t SH_FILES < <(git ls-files 'install.sh' 'Yoyoo/project/bootstrap/*.sh' 'scripts/*.sh')
          if [ "${#SH_FILES[@]}" -eq 0 ]; then
            echo "No shell files found for lint."
            exit 0
          fi

          echo "Checking syntax for:"
          printf '  %s\n' "${SH_FILES[@]}"
          for file in "${SH_FILES[@]}"; do
            bash -n "${file}"
          done

          shellcheck -x -S warning -e SC1091 "${SH_FILES[@]}"

      - name: Policy checks (must stay stable)
        run: |
          set -euo pipefail
          if grep -R --line-number 'openclaw@latest' install.sh Yoyoo/project/bootstrap/*.sh; then
            echo "Policy violation: openclaw@latest is not allowed in baseline scripts."
            exit 1
          fi

          if grep -R --line-number 'release/yoyoo-1.0-rc1' Yoyoo/project/bootstrap/hire_employee_from_git.sh Yoyoo/project/bootstrap/README.md; then
            echo "Policy violation: release/yoyoo-1.0-rc1 should not be default anymore."
            exit 1
          fi

          if grep -R --line-number '/usr/bin/openclaw' Yoyoo/project/bootstrap/activate_employee.sh; then
            echo "Policy violation: hardcoded /usr/bin/openclaw is forbidden."
            exit 1
          fi

  backend-tests:
    runs-on: ubuntu-latest
    needs: shell-and-policy
    defaults:
      run:
        working-directory: Yoyoo/project/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: PYTHONPATH=. pytest -q

      - name: Lint backend
        run: PYTHONPATH=. ruff check .

