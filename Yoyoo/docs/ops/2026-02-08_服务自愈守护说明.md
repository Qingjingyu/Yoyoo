# Yoyoo 服务自愈守护说明

## 目标
- 防止 `openclaw` / `nanobot` 出现“进程活着但不可用”或异常退出后无人恢复。
- 通过 systemd 定时巡检 + 自动重启，提升长期可用性。

## 已部署组件（服务器）
- 健康检查脚本：`/usr/local/bin/yoyoo_guardian.sh`
- 检查服务：`yoyoo-guardian.service`（oneshot）
- 定时器：`yoyoo-guardian.timer`（每 60 秒执行一次）
- 状态文件：`/var/lib/yoyoo-guardian/state.env`

## 健康检查规则
### OpenClaw
- `openclaw.service` 必须是 `active`
- 网关端口 `127.0.0.1:18789` 必须监听
- 最近日志中必须有 `event tick/health/heartbeat`，且不超时

### Nanobot
- `nanobot.service` 必须是 `active`
- `MainPID` 必须有效且进程存在
- 进程需存在到 `:443` 的 TLS 长连接（飞书长连）
- 最近活动日志不能长期停滞

## 重启策略
- 硬故障（inactive / 无 MainPID）立即重启
- 软故障（监听缺失/连接缺失/活动停滞）连续 2 次异常后重启
- 重启后自动清零失败计数

## 常用命令
```bash
# 看守护定时器状态
systemctl status yoyoo-guardian.timer --no-pager

# 立即执行一次健康检查
systemctl start yoyoo-guardian.service

# 查看守护事件日志
journalctl -t yoyoo-guardian -n 100 --no-pager

# 查看当前失败计数
cat /var/lib/yoyoo-guardian/state.env
```
