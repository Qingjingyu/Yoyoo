# Windows 节点一次授权后自动化（Yoyoo 模式）

## 目标
- 你只做一次管理员授权。
- 后续由 Yoyoo 自动巡检 Windows 节点是否可用。
- 可选：Yoyoo 远程下发命令到 Windows（通过 token）。

## 1. Windows 一次性执行（管理员 PowerShell）
脚本路径：`Yoyoo/project/scripts/windows_yoyoo_worker_bootstrap.ps1`

最省事方式（推荐）：
- 由服务器通过 Tailscale 直接投递安装包 `yoyoo_windows_bundle.zip` 到你的 Windows。
- 你只需解压后双击：`install_yoyoo_worker_admin.cmd`。
- 脚本会自动申请管理员权限并完成安装。

推荐直接下载执行（同一 tailnet）：
```powershell
$token = "你自己设置的强随机Token"
irm "http://100.82.189.93:18999/windows_yoyoo_worker_bootstrap.ps1" -OutFile "$env:TEMP\\yoyoo_worker_bootstrap.ps1"
powershell -ExecutionPolicy Bypass -File "$env:TEMP\\yoyoo_worker_bootstrap.ps1" -Token $token
```

示例命令：
```powershell
Set-ExecutionPolicy -Scope Process Bypass -Force
& "C:\path\to\windows_yoyoo_worker_bootstrap.ps1" -Token "你的强随机Token"
```

执行成功后会输出：
- `Port: 8088`
- `Task: YoyooWorker`
- `Token: ...`
- `Health: {"ok":true,...}`

说明：
- 已自动注册开机自启任务 `YoyooWorker`（SYSTEM 权限）。
- 已自动配置 URLACL 与防火墙端口。
- 以后重启电脑会自动恢复。

## 2. 服务器侧自动巡检
巡检脚本：`Yoyoo/project/scripts/yoyoo_windows_node_check.sh`

在服务器执行：
```bash
YOYOO_WINDOWS_TOKEN='你的强随机Token' \
  bash /root/yoyoo/Yoyoo/project/scripts/yoyoo_windows_node_check.sh 100.92.126.71
```

返回 `ok:true` 即为可用。

## 3. 常见故障
- `health_unreachable`：Windows 任务未启动或防火墙/URLACL 失效。
- `exec_failed`：token 不匹配或 worker 异常。
- `ssh_enabled=false`：仅说明 Tailscale SSH 未开，不影响本 worker 模式。

## 4. 推荐运维动作
- 每 1 分钟跑一次巡检（systemd timer 或 cron）。
- 连续 2 次失败时，提醒你在 Windows 执行：
  ```powershell
  Start-ScheduledTask -TaskName YoyooWorker
  ```
