# å‘é‡æ•°æ®åº“å­¦ä¹ ç¬”è®°

> **å­¦ä¹ æ—¥æœŸ**: 2026-01-31
> **çŠ¶æ€**: ğŸ”¥ è¿›è¡Œä¸­
> **å…³è”**: Moltbot ä¸‰å±‚è®°å¿†æ¶æ„

---

## 1. ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“ï¼Ÿ

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‘é‡ vs æ ‡é‡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  æ ‡é‡æ•°æ®                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ "è‹¹æœ" â”‚ "é¦™è•‰" â”‚ "æ©™å­" â”‚ "è‘¡è„" â”‚ "è¥¿ç“œ" â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚       â†“ ç²¾ç¡®åŒ¹é…                                        â”‚
â”‚  WHERE name = 'è‹¹æœ'                                    â”‚
â”‚                                                         â”‚
â”‚  å‘é‡æ•°æ® (Embedding)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [0.92, 0.01, -0.03, ...]  "è‹¹æœ"                 â”‚  â”‚
â”‚  â”‚ [0.87, 0.05,  0.12, ...]  "é¦™è•‰"                 â”‚  â”‚
â”‚  â”‚ [0.45, 0.78,  0.23, ...]  "æ©™å­"                 â”‚  â”‚
â”‚  â”‚ [0.51, 0.69, -0.11, ...]  "è‘¡è„"                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â†“ è¯­ä¹‰ç›¸ä¼¼åº¦                                      â”‚
â”‚  Cosine Similarity("è‹¹æœ", "é¦™è•‰") â‰ˆ 0.85              â”‚
â”‚  Cosine Similarity("è‹¹æœ", "æ©™å­") â‰ˆ 0.42              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ

| ä¼ ç»Ÿæ•°æ®åº“ | å‘é‡æ•°æ®åº“ |
|-----------|-----------|
| ç²¾ç¡®åŒ¹é… | è¯­ä¹‰æœç´¢ |
| å…³é”®è¯åŒ¹é… | ç›¸ä¼¼åº¦æœç´¢ |
| ç»“æ„åŒ–æŸ¥è¯¢ | è‡ªç„¶è¯­è¨€æŸ¥è¯¢ |
| æ…¢ (O(n)) | å¿« (O(log n)) |

### 1.3 Yoyoo çš„åº”ç”¨åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Yoyoo è®°å¿†ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ç”¨æˆ·è¾“å…¥: "æˆ‘æ˜¨å¤©å’Œè‹ç™½è®¨è®ºäº†é¡¹ç›®è®¡åˆ’"                  â”‚
â”‚       â†“                                                â”‚
â”‚  è½¬æ¢ä¸ºå‘é‡: [0.12, -0.34, 0.56, ...]                  â”‚
â”‚       â†“                                                â”‚
â”‚  å‘é‡æœç´¢ â†’ æ‰¾åˆ°ç›¸ä¼¼è®°å¿†                                â”‚
â”‚       â†“                                                â”‚
â”‚  è¿”å›: "2026-01-30: ä¸è‹ç™½è®¨è®º V2.0 äº§å“è®¾è®¡"          â”‚
â”‚                                                         â”‚
â”‚  åº”ç”¨åœºæ™¯:                                              â”‚
â”‚  â€¢ é•¿æœŸè®°å¿†æ£€ç´¢                                         â”‚
â”‚  â€¢ ä¸Šä¸‹æ–‡å¢å¼º (RAG)                                     â”‚
â”‚  â€¢ ç”¨æˆ·åå¥½å­¦ä¹                                          â”‚
â”‚  â€¢ çŸ¥è¯†åº“é—®ç­”                                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å‘é‡åŸºç¡€çŸ¥è¯†

### 2.1 Embedding æ¨¡å‹

| æ¨¡å‹ | ç»´åº¦ | ç‰¹ç‚¹ | ç”¨é€” |
|------|------|------|------|
| **text-embedding-ada-002** | 1536 | OpenAI é»˜è®¤ï¼Œä¾¿å®œ | é€šç”¨ |
| **text-embedding-3-small** | 512/1024 | æ–°ç‰ˆï¼Œæ›´å¿« | æˆæœ¬æ•æ„Ÿ |
| **text-embedding-3-large** | 3072 | æ–°ç‰ˆï¼Œæ›´ç²¾ç¡® | é«˜ç²¾åº¦ |
| **Cohere embed-multilingual-v3.0** | 1024 | å¤šè¯­è¨€æ”¯æŒ | å¤šè¯­è¨€ |
| **BAAI/bge-large-zh** | 1024 | ä¸­æ–‡ä¼˜åŒ– | ä¸­æ–‡åœºæ™¯ |

### 2.2 ç›¸ä¼¼åº¦åº¦é‡

```python
import numpy as np

# ä½™å¼¦ç›¸ä¼¼åº¦ (æœ€å¸¸ç”¨)
def cosine_similarity(a, b):
    return np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))

# æ¬§æ°è·ç¦»
def euclidean_distance(a, b):
    return np.linalg.norm(a - b)

# ç‚¹ç§¯
def dot_product(a, b):
    return np.dot(a, b)

# ç¤ºä¾‹
v1 = [0.92, 0.01, -0.03]
v2 = [0.87, 0.05,  0.12]

print(f"Cosine: {cosine_similarity(v1, v2):.3f}")  # 0.978
print(f"Euclidean: {euclidean_distance(v1, v2):.3f}")  # 0.18
```

### 2.3 å‘é‡ç´¢å¼•ç®—æ³•

| ç®—æ³• | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **IVF** | å€’æ’æ–‡ä»¶ | å¿«é€Ÿï¼Œç²¾åº¦å¯è°ƒ | å¤§è§„æ¨¡æ•°æ® |
| **HNSW** | å›¾ç´¢å¼• | å¿«é€Ÿï¼Œå†…å­˜å ç”¨é«˜ | ä¸­å°è§„æ¨¡ |
| **PQ** | é‡åŒ– | å‹ç¼©å­˜å‚¨ | è¶…å¤§è§„æ¨¡ |
| **LSH** | å“ˆå¸Œ | è¿‘ä¼¼æœç´¢ | å¿«é€Ÿè¿‘ä¼¼ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç´¢å¼•ç®—æ³•å¯¹æ¯”                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  HNSW (Hierarchical Navigable Small World)             â”‚
â”‚  â”œâ”€â”€ æ„å»ºæ…¢ï¼ŒæŸ¥è¯¢å¿«                                     â”‚
â”‚  â”œâ”€â”€ å†…å­˜å ç”¨é«˜                                         â”‚
â”‚  â””â”€â”€ ç²¾åº¦æœ€é«˜                                           â”‚
â”‚                                                         â”‚
â”‚  IVF (Inverted File Index)                             â”‚
â”‚  â”œâ”€â”€ æ„å»ºå¿«ï¼ŒæŸ¥è¯¢è¾ƒå¿«                                   â”‚
â”‚  â”œâ”€â”€ å†…å­˜å ç”¨ä½                                         â”‚
â”‚  â””â”€â”€ éœ€è¦è°ƒå‚ (nprobe)                                  â”‚
â”‚                                                         â”‚
â”‚  ç»„åˆ: IVF + PQ                                         â”‚
â”‚  â”œâ”€â”€ è¶…å¤§è§„æ¨¡å‹ç¼©                                       â”‚
â”‚  â””â”€â”€ ç²¾åº¦ç•¥æœ‰ä¸‹é™                                       â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å‘é‡æ•°æ®åº“é€‰å‹

### 3.1 ä¸»æµæ–¹æ¡ˆå¯¹æ¯”

| æ•°æ®åº“ | ç±»å‹ | ç‰¹ç‚¹ | å®šä»· |
|--------|------|------|------|
| **Pinecone** | äº‘æœåŠ¡ | æ‰˜ç®¡å‘é‡ï¼Œæ˜“ç”¨ | æŒ‰ç”¨é‡ |
| **Milvus** | å¼€æº | åŠŸèƒ½ä¸°å¯Œï¼Œè‡ªæ‰˜ç®¡ | å…è´¹ |
| **Weaviate** | å¼€æº+äº‘ | Graph + Vector | å…è´¹/äº‘ |
| **Qdrant** | å¼€æº+äº‘ | Rust å®ç°ï¼Œé«˜æ€§èƒ½ | å…è´¹/äº‘ |
| **Chroma** | å¼€æº | è½»é‡ï¼ŒPython ä¼˜å…ˆ | å…è´¹ |
| **pgvector** | PostgreSQL æ‰©å±• | ç®€å•ï¼Œé›†æˆæ–¹ä¾¿ | å…è´¹ |

### 3.2 Yoyoo æ¨èæ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Yoyoo å‘é‡å­˜å‚¨ç­–ç•¥                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  é˜¶æ®µ 1: MVP                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  pgvector (PostgreSQL æ‰©å±•)                      â”‚   â”‚
â”‚  â”‚  â€¢ ç®€å•ï¼Œæ— éœ€é¢å¤–æœåŠ¡                             â”‚   â”‚
â”‚  â”‚  â€¢ ä¸ä¸»æ•°æ®åº“é›†æˆ                                â”‚   â”‚
â”‚  â”‚  â€¢ 10K - 1M å‘é‡å¤Ÿç”¨                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  é˜¶æ®µ 2: è§„æ¨¡åŒ–                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Milvus / Qdrant (ç‹¬ç«‹å‘é‡æ•°æ®åº“)                â”‚   â”‚
â”‚  â”‚  â€¢ æ›´å¥½çš„æ‰©å±•æ€§                                  â”‚   â”‚
â”‚  â”‚  â€¢ é«˜çº§ç´¢å¼•é€‰é¡¹                                  â”‚   â”‚
â”‚  â”‚  â€¢ ç™¾ä¸‡çº§å‘é‡                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  é˜¶æ®µ 3: äº‘æœåŠ¡                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Pinecone / Weaviate Cloud                      â”‚   â”‚
â”‚  â”‚  â€¢ å®Œå…¨æ‰˜ç®¡                                      â”‚   â”‚
â”‚  â”‚  â€¢ å…¨çƒéƒ¨ç½²                                      â”‚   â”‚
â”‚  â”‚  â€¢ æ— é™æ‰©å±•                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. pgvector å®æˆ˜

### 4.1 å®‰è£…

```sql
-- PostgreSQL æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- éªŒè¯å®‰è£…
SELECT * FROM pg_extension WHERE extname = 'vector';
```

### 4.2 è¡¨è®¾è®¡

```sql
-- è®°å¿†è¡¨
CREATE TABLE memories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL,
    user_id UUID NOT NULL,
    type VARCHAR(50) NOT NULL,           -- 'fact', 'preference', 'context'
    content TEXT NOT NULL,                -- åŸå§‹æ–‡æœ¬
    embedding vector(1536),               -- OpenAI Ada-002 ç»´åº¦
    metadata JSONB DEFAULT '{}',          -- é¢å¤–ä¿¡æ¯
    importance FLOAT DEFAULT 0.5,         -- é‡è¦æ€§è¯„åˆ†
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼• (HNSW)
CREATE INDEX ON memories USING hnsw (embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);

-- åˆ›å»ºç´¢å¼• (IVF)
-- CREATE INDEX ON memories USING ivfflat (embedding vector_cosine_ops)
--   WITH (lists = 100);
```

### 4.3 åŸºç¡€æ“ä½œ

```python
import asyncpg
import openai

# 1. ç”Ÿæˆå‘é‡
async def get_embedding(text: str) -> list:
    response = await openai.Embedding.acreate(
        model="text-embedding-ada-002",
        input=text
    )
    return response['data'][0]['embedding']

# 2. æ’å…¥è®°å¿†
async def add_memory(conn, memory_data):
    embedding = await get_embedding(memory_data['content'])

    await conn.execute('''
        INSERT INTO memories (tenant_id, user_id, type, content, embedding, metadata, importance)
        VALUES ($1, $2, $3, $4, $5, $6, $7)
    ''',
        memory_data['tenant_id'],
        memory_data['user_id'],
        memory_data['type'],
        memory_data['content'],
        embedding,
        json.dumps(memory_data.get('metadata', {})),
        memory_data.get('importance', 0.5)
    )

# 3. ç›¸ä¼¼åº¦æœç´¢
async def search_memories(conn, query: str, user_id: UUID, limit: int = 5):
    query_embedding = await get_embedding(query)

    rows = await conn.fetch('''
        SELECT id, type, content, metadata,
               1 - (embedding <=> $1) as similarity
        FROM memories
        WHERE user_id = $2
        ORDER BY embedding <=> $1
        LIMIT $3
    ''', query_embedding, user_id, limit)

    return [dict(row) for row in rows]

# <=> æ“ä½œç¬¦: ä½™å¼¦è·ç¦» (1 - cosine_similarity)
```

### 4.4 é«˜çº§æŸ¥è¯¢

```sql
-- 1. å¸¦è¿‡æ»¤çš„æœç´¢
SELECT id, content, 1 - (embedding <=> $1) as similarity
FROM memories
WHERE user_id = $2
  AND type = 'fact'
  AND importance > 0.3
ORDER BY embedding <=> $1
LIMIT 10;

-- 2. åˆ†ç»„èšåˆ (Moltbot é£æ ¼)
SELECT type,
       COUNT(*) as count,
       AVG(importance) as avg_importance
FROM memories
WHERE user_id = $1
GROUP BY type
ORDER BY avg_importance DESC;

-- 3. åˆ é™¤è¿‡æœŸè®°å¿† (é‡è¦æ€§ä½äºé˜ˆå€¼)
DELETE FROM memories
WHERE user_id = $1
  AND importance < 0.1
  AND created_at < NOW() - INTERVAL '90 days';

-- 4. æ›´æ–°å‘é‡ (å½“äº‹å®å˜åŒ–æ—¶)
UPDATE memories
SET embedding = $2,
    updated_at = NOW()
WHERE id = $1;

-- 5. ç»Ÿè®¡
SELECT
  COUNT(*) as total,
  COUNT(DISTINCT user_id) as users,
  AVG(vector_dimension(embedding)) as avg_dim
FROM memories;
```

---

## 5. Milvus å®æˆ˜

### 5.1 Docker éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.5'

services:
  etcd:
    container_name: milvus-etcd
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3

  minio:
    container_name: milvus-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9001:9001"
      - "9000:9000"
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  standalone:
    container_name: milvus-standalone
    image: milvusdb/milvus:v2.3.4
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 3
    ports:
      - "19530:19530"
      - "9091:9091"

volumes:
  etcd_data:
  minio_data:
  milvus_data:
```

### 5.2 Python SDK

```python
from pymilvus import (
    Collection, CollectionSchema, FieldSchema,
    DataType, connections, utility
)
from sentence_transformers import SentenceTransformer

# 1. è¿æ¥
connections.connect("default", host="localhost", port="19530")

# 2. å®šä¹‰ Collection
fields = [
    FieldSchema(name="id", dtype=DataType.UUID, is_primary=True),
    FieldSchema(name="tenant_id", dtype=DataType.UUID),
    FieldSchema(name="user_id", dtype=DataType.UUID),
    FieldSchema(name="type", dtype=DataType.VARCHAR, max_length=50),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=1536),
    FieldSchema(name="metadata", dtype=DataType.JSON),
    FieldSchema(name="importance", dtype=DataType.FLOAT),
    FieldSchema(name="created_at", dtype=DataType.VARCHAR, max_length=50),
]

schema = CollectionSchema(fields=fields, description="Yoyoo memories")

# 3. åˆ›å»º Collection
if utility.has_collection("memories"):
    utility.drop_collection("memories")

collection = Collection("memories", schema)

# 4. åˆ›å»ºç´¢å¼•
index_params = {
    "metric_type": "COSINE",
    "index_type": "HNSW",
    "params": {"M": 16, "efConstruction": 64}
}

collection.create_index("embedding", index_params)

# 5. åŠ è½½åˆ°å†…å­˜
collection.load()

# 6. æ’å…¥æ•°æ®
model = SentenceTransformer("all-MiniLM-L6-v2")

memories = [
    {"id": "uuid-1", "tenant_id": "t1", "user_id": "u1",
     "type": "fact", "content": "è‹ç™½å–œæ¬¢å–å’–å•¡",
     "embedding": model.encode("è‹ç™½å–œæ¬¢å–å’–å•¡"), "importance": 0.8},
    {"id": "uuid-2", "tenant_id": "t1", "user_id": "u1",
     "type": "preference", "content": "è‹ç™½åå¥½æ·±è‰²ä¸»é¢˜",
     "embedding": model.encode("è‹ç™½åå¥½æ·±è‰²ä¸»é¢˜"), "importance": 0.7},
]

entities = [
    [m["id"] for m in memories],
    [m["tenant_id"] for m in memories],
    [m["user_id"] for m in memories],
    [m["type"] for m in memories],
    [m["content"] for m in memories],
    [m["embedding"].tolist() for m in memories],
    [m["metadata"] for m in memories],
    [m["importance"] for m in memories],
    [str(m["created_at"]) for m in memories],
]

collection.insert(entities)

# 7. æœç´¢
search_params = {"metric_type": "COSINE", "params": {"ef": 64}}

results = collection.search(
    data=[model.encode("è‹ç™½çš„å–œå¥½")],
    anns_field="embedding",
    param=search_params,
    limit=5,
    expr="user_id == 'u1'"
)

for result in results[0]:
    print(f"ID: {result.id}, Distance: {result.distance}, Content: {result.entity.get('content')}")
```

---

## 6. RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ)

### 6.1 RAG æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RAG æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ç”¨æˆ·é—®é¢˜: "è‹ç™½æœ€è¿‘åœ¨åšä»€ä¹ˆé¡¹ç›®ï¼Ÿ"                     â”‚
â”‚       â”‚                                                â”‚
â”‚       â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Embedding (å°†é—®é¢˜è½¬ä¸ºå‘é‡)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                â”‚
â”‚       â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. å‘é‡æ£€ç´¢ (ä»è®°å¿†åº“ä¸­æ‰¾ç›¸å…³è®°å¿†)               â”‚   â”‚
â”‚  â”‚     - è‹ç™½åœ¨åš Yoyoo V2.0 (ç›¸ä¼¼åº¦ 0.92)          â”‚   â”‚
â”‚  â”‚     - æœ€è¿‘åœ¨ç ”ç©¶åä½œåè®® (ç›¸ä¼¼åº¦ 0.85)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                â”‚
â”‚       â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. ä¸Šä¸‹æ–‡æ„å»º (å°†æ£€ç´¢ç»“æœæ‹¼æ¥åˆ° prompt)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                â”‚
â”‚       â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. LLM ç”Ÿæˆ (åŸºäºä¸Šä¸‹æ–‡å›ç­”)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                â”‚
â”‚       â†“                                                â”‚
â”‚  è¾“å‡º: "è‹ç™½æœ€è¿‘åœ¨åš Yoyoo V2.0 é¡¹ç›®ï¼Œè¿™æ˜¯ä¸€ä¸ª       â”‚
â”‚       å¤šç”¨æˆ·æ™ºèƒ½ä»£ç†åä½œå¹³å°ã€‚ä»–æœ€è¿‘è¿˜ç ”ç©¶äº†          â”‚
â”‚       å¤š Yoyoo åä½œåè®®çš„è®¾è®¡ã€‚"                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 RAG å®ç°

```python
class RAGSystem:
    def __init__(self, conn, embedding_model):
        self.conn = conn
        self.embedding_model = embedding_model

    async def retrieve(self, query: str, user_id: UUID, k: int = 5) -> list:
        """æ£€ç´¢ç›¸å…³è®°å¿†"""
        query_embedding = await self.embedding_model.encode(query)

        rows = await self.conn.fetch('''
            SELECT id, type, content, metadata, importance,
                   1 - (embedding <=> $1) as similarity
            FROM memories
            WHERE user_id = $1
              AND importance > 0.3
            ORDER BY embedding <=> $1
            LIMIT $2
        ''', query_embedding, k)

        return [dict(row) for row in rows]

    def build_context(self, query: str, memories: list) -> str:
        """æ„å»º RAG ä¸Šä¸‹æ–‡"""
        context_parts = [f"é—®é¢˜: {query}\n"]

        if memories:
            context_parts.append("ç›¸å…³è®°å¿†:")
            for m in memories:
                context_parts.append(f"- [{m['type']}] {m['content']}")

        return "\n".join(context_parts)

    async def answer(self, question: str, user_id: UUID) -> str:
        """å›ç­”é—®é¢˜"""
        # 1. æ£€ç´¢
        memories = await self.retrieve(question, user_id)

        # 2. æ„å»ºä¸Šä¸‹æ–‡
        context = self.build_context(question, memories)

        # 3. ç”Ÿæˆå›ç­”
        prompt = f"""
ä½ æ˜¯ Yoyooï¼Œä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯ç”¨æˆ·çš„é•¿æœŸè®°å¿†ï¼š

{context}

è¯·åŸºäºä»¥ä¸Šè®°å¿†å›ç­”é—®é¢˜ã€‚å¦‚æœè®°å¿†ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è¯´ä½ ä¸çŸ¥é“ã€‚
"""
        response = await openai.ChatCompletion.acreate(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}]
        )

        return response.choices[0].message.content
```

---

## 7. è®°å¿†ç³»ç»Ÿè®¾è®¡ (Moltbot é£æ ¼)

### 7.1 ä¸‰å±‚è®°å¿†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Moltbot ä¸‰å±‚è®°å¿†æ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Layer 1: çŸ¥è¯†å›¾è°± (Knowledge Graph)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  people/                                          â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è‹ç™½/                                      â”‚   â”‚
â”‚  â”‚        â”œâ”€â”€ summary.md  (åŠ¨æ€æ‘˜è¦)                â”‚   â”‚
â”‚  â”‚        â””â”€â”€ items.json   (åŸå­äº‹å®)               â”‚   â”‚
â”‚  â”‚           - "è‹ç™½æ˜¯ Yoyoo çš„åˆ›é€ è€…"               â”‚   â”‚
â”‚  â”‚           - "è‹ç™½åå¥½ VSCode"                     â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚  companies/                                       â”‚   â”‚
â”‚  â”‚  projects/                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  Layer 2: æ¯æ—¥ç¬”è®° (Daily Notes)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  BRAIN/MEMORY/daily/                             â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ 2026-01-30.md  (åŸå§‹äº‹ä»¶æ—¥å¿—)             â”‚   â”‚
â”‚  â”‚    â””â”€â”€ 2026-01-31.md                             â”‚   â”‚
â”‚  â”‚       - "14:30 ä¸è‹ç™½è®¨è®ºåä½œåè®®"               â”‚   â”‚
â”‚  â”‚       - "16:00 å®Œæˆ Git å·¥ä½œæµå­¦ä¹ "              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  Layer 3: éšæ€§çŸ¥è¯† (Implicit Memory)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MEMORY.md                                        â”‚   â”‚
â”‚  â”‚    - ç”¨æˆ·åå¥½æ¨¡å¼                                 â”‚   â”‚
â”‚  â”‚    - ç³»ç»Ÿè®¾è®¡å†³ç­–                                 â”‚   â”‚
â”‚  â”‚    - ç»éªŒæ•™è®­æ€»ç»“                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  â”‚  å‘é‡ç´¢å¼•: pgvector (åŠ é€Ÿæ£€ç´¢)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è®°å¿†æå–æµç¨‹

```python
import asyncio
from datetime import datetime

class MemoryExtractor:
    """ä»å¯¹è¯ä¸­æå–å’ŒæŒä¹…åŒ–è®°å¿†"""

    def __init__(self, conn, embedding_model):
        self.conn = conn
        self.embedding_model = embedding_model

    async def extract_from_conversation(self, user_id: UUID, conversation: list):
        """ä»å¯¹è¯ä¸­æå–æ–°è®°å¿†"""
        facts = []

        for message in conversation:
            if message['role'] == 'user':
                # åˆ†æç”¨æˆ·è¾“å…¥ï¼Œæå–äº‹å®
                new_facts = await self.analyze_for_facts(message['content'])
                facts.extend(new_facts)

        # æŒä¹…åŒ–æ–°äº‹å®
        for fact in facts:
            await self.persist_fact(user_id, fact)

        # æ¯å‘¨ç»¼åˆæ•´ç†
        if datetime.now().weekday() == 0:  # å‘¨ä¸€
            await self.weekly_consolidation(user_id)

    async def analyze_for_facts(self, text: str) -> list:
        """ä½¿ç”¨ LLM åˆ†ææ–‡æœ¬ï¼Œæå–åŸå­äº‹å®"""
        prompt = f"""
ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–åŸå­äº‹å®ï¼ˆç”¨æˆ·åå¥½ã€é‡è¦ä¿¡æ¯ç­‰ï¼‰ã€‚
è¿”å› JSON æ•°ç»„ï¼Œæ¯ä¸ªäº‹å®åŒ…å«: type, content, importance

æ–‡æœ¬: {text}

ç¤ºä¾‹è¾“å‡º:
[
  {{"type": "preference", "content": "ç”¨æˆ·å–œæ¬¢ç®€æ´çš„ç•Œé¢", "importance": 0.7}},
  {{"type": "fact", "content": "ç”¨æˆ·åœ¨åšä¸€ä¸ª AI é¡¹ç›®", "importance": 0.9}}
]
"""
        response = await openai.ChatCompletion.acreate(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            response_format={"type": "json_object"}
        )

        import json
        result = json.loads(response.choices[0].message.content)
        return result.get('facts', [])

    async def persist_fact(self, user_id: UUID, fact: dict):
        """æŒä¹…åŒ–äº‹å®åˆ°å‘é‡æ•°æ®åº“"""
        embedding = await self.embedding_model.encode(fact['content'])

        await self.conn.execute('''
            INSERT INTO memories (user_id, type, content, embedding, importance)
            VALUES ($1, $2, $3, $4, $5)
        ''', user_id, fact['type'], fact['content'], embedding, fact['importance'])

    async def weekly_consolidation(self, user_id: UUID):
        """æ¯å‘¨ç»¼åˆæ•´ç†"""
        # 1. èšåˆæœ¬å‘¨è®°å¿†
        rows = await self.conn.fetch('''
            SELECT type, content, importance
            FROM memories
            WHERE user_id = $1
              AND created_at > NOW() - INTERVAL '7 days'
        ''', user_id)

        # 2. æ›´æ–°æ‘˜è¦
        summary = self.generate_summary(rows)

        # 3. æ ‡è®°è¿‡æ—¶ä¿¡æ¯
        await self.conn.execute('''
            UPDATE memories
            SET metadata = metadata || '{"consolidated": true}'
            WHERE user_id = $1
              AND created_at <= NOW() - INTERVAL '7 days'
        ''', user_id)

        # 4. ä¿å­˜æ–°æ‘˜è¦
        await self.persist_fact(user_id, {
            'type': 'summary',
            'content': summary,
            'importance': 0.8
        })
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ç´¢å¼•è°ƒä¼˜

```sql
-- HNSW å‚æ•°è°ƒä¼˜
-- M: æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•° (4-64, é»˜è®¤ 16)
-- efConstruction: æ„å»ºæ—¶çš„æœç´¢å®½åº¦ (8-512, é»˜è®¤ 64)

-- é«˜ç²¾åº¦ (æ„å»ºæ…¢ï¼ŒæŸ¥è¯¢æ…¢)
CREATE INDEX ON memories USING hnsw (embedding vector_cosine_ops)
  WITH (m = 32, ef_construction = 256);

-- å¿«é€ŸæŸ¥è¯¢ (ç²¾åº¦ç•¥é™)
CREATE INDEX ON memories USING hnsw (embedding vector_cosine_ops)
  WITH (m = 8, ef_construction = 32);

-- IVF å‚æ•°è°ƒä¼˜
-- lists: èšç±»æ•°é‡ (sqrt(n) åˆ° n/1000)
-- å¯¹äº 100K å‘é‡ï¼Œlists = 300

CREATE INDEX ON memories USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 300);
```

### 8.2 æŸ¥è¯¢ä¼˜åŒ–

```python
# 1. æ‰¹é‡æ’å…¥ (æ€§èƒ½æå‡ 10x+)
async def batch_insert_memories(conn, memories: list):
    embeddings = await asyncio.gather(*[
        get_embedding(m['content']) for m in memories
    ])

    async with conn.transaction():
        for m, emb in zip(memories, embeddings):
            await conn.execute('''
                INSERT INTO memories (user_id, type, content, embedding, importance)
                VALUES ($1, $2, $3, $4, $5)
            ''', m['user_id'], m['type'], m['content'], emb, m['importance'])

# 2. å¼‚æ­¥æœç´¢
async def parallel_search(conn, queries: list, user_id: UUID):
    embeddings = await asyncio.gather(*[
        get_embedding(q) for q in queries
    ])

    tasks = [
        conn.fetch('''
            SELECT id, content, 1 - (embedding <=> $1) as similarity
            FROM memories
            WHERE user_id = $2
            ORDER BY embedding <=> $1
            LIMIT 5
        ''', emb, user_id)
        for emb in embeddings
    ]

    return await asyncio.gather(*tasks)
```

---

## 9. å­¦ä¹ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å‘é‡æ•°æ®åº“**: ç”¨äºè¯­ä¹‰æœç´¢ã€ç›¸ä¼¼åº¦åŒ¹é…
2. **Embedding**: å°†æ–‡æœ¬è½¬ä¸ºå‘é‡ï¼Œæ•æ‰è¯­ä¹‰ä¿¡æ¯
3. **ç´¢å¼•é€‰æ‹©**: HNSW (é«˜ç²¾åº¦) vs IVF (å¤§è§„æ¨¡)
4. **pgvector**: MVP é˜¶æ®µæœ€ä½³é€‰æ‹©ï¼Œé›†æˆç®€å•
5. **RAG**: æ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œç»“åˆè®°å¿† + LLM
6. **è®°å¿†æ¶æ„**: Moltbot ä¸‰å±‚è®°å¿† + å‘é‡åŒ–

### Yoyoo è®°å¿†ç³»ç»Ÿ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å­˜å‚¨ | pgvector | PostgreSQL æ‰©å±• |
| æ£€ç´¢ | HNSW ç´¢å¼• | ä½™å¼¦ç›¸ä¼¼åº¦ |
| Embedding | OpenAI Ada-002 | 1536 ç»´ |
| æ¶æ„ | ä¸‰å±‚è®°å¿† | çŸ¥è¯†å›¾è°± + æ¯æ—¥ç¬”è®° + éšæ€§çŸ¥è¯† |
| æå– | LLM è‡ªåŠ¨æå– | æ¯å‘¨ç»¼åˆæ•´ç† |

---

## å‚è€ƒèµ„æº

- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [Milvus Documentation](https://milvus.io/docs)
- [Pinecone Documentation](https://docs.pinecone.io)
- [HNSW Paper](https://arxiv.org/abs/1603.09320)
- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings)
- [RAG æœ€ä½³å®è·µ](https://www.promptingguide.ai/techniques/rag)
