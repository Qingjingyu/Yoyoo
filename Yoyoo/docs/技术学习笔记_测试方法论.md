# æµ‹è¯•æ–¹æ³•è®ºå­¦ä¹ ç¬”è®°

> **å­¦ä¹ æ—¥æœŸ**: 2026-01-31
> **çŠ¶æ€**: ğŸ”¥ è¿›è¡Œä¸­

---

## 1. æµ‹è¯•é‡‘å­—å¡”

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æµ‹è¯•é‡‘å­—å¡”                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚                        /\\                              â”‚
â”‚                       /  \\                             â”‚
â”‚                      / Unit \\     å•å…ƒæµ‹è¯•             â”‚
â”‚                     /â”€â”€â”€â”€â”€â”€â”€â”€\\   70%                   â”‚
â”‚                    /  Integration  \\                   â”‚
â”‚                   /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\  20%             â”‚
â”‚                  /     E2E Tests      \\                â”‚
â”‚                 /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\  10%      â”‚
â”‚                                                         â”‚
â”‚  ç‰¹ç‚¹:                                                   â”‚
â”‚  â€¢ åº•å±‚å¹¿ (å•å…ƒæµ‹è¯•å¤š)                                   â”‚
â”‚  â€¢ é¡¶å±‚çª„ (E2E æµ‹è¯•å°‘)                                   â”‚
â”‚  â€¢ è¿è¡Œé€Ÿåº¦: å•å…ƒ > é›†æˆ > E2E                           â”‚
â”‚  â€¢ æˆæœ¬: å•å…ƒ < é›†æˆ < E2E                               â”‚
â”‚  â€¢ ç½®ä¿¡åº¦: å•å…ƒ < é›†æˆ < E2E                             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æµ‹è¯•ç±»å‹å¯¹æ¯”

| ç±»å‹ | èŒƒå›´ | é€Ÿåº¦ | ç½®ä¿¡åº¦ | ç”¨é€” |
|------|------|------|--------|------|
| **å•å…ƒæµ‹è¯•** | å•ä¸ªå‡½æ•°/ç±» | å¿« (ms) | ä½ | é€»è¾‘æ­£ç¡®æ€§ |
| **é›†æˆæµ‹è¯•** | å¤šä¸ªæ¨¡å— | ä¸­ (s) | ä¸­ | æ¨¡å—äº¤äº’ |
| **E2E æµ‹è¯•** | å®Œæ•´ç³»ç»Ÿ | æ…¢ (min) | é«˜ | ç”¨æˆ·åœºæ™¯ |

---

## 2. å•å…ƒæµ‹è¯• (Unit Testing)

### 2.1 Python æµ‹è¯•æ¡†æ¶

```python
# pytest - Python æœ€æµè¡Œçš„æµ‹è¯•æ¡†æ¶

# å®‰è£…
pip install pytest pytest-asyncio pytest-cov

# åŸºæœ¬ç¤ºä¾‹
# tests/test_math.py
import pytest

def test_addition():
    assert 1 + 1 == 2

def test_subtraction():
    assert 5 - 3 == 2

def test_list_operations():
    numbers = [1, 2, 3]
    assert len(numbers) == 3
    assert sum(numbers) == 6

# ä½¿ç”¨ fixture
# tests/conftest.py
import pytest
from app import Calculator

@pytest.fixture
def calculator():
    return Calculator()

def test_multiply(calculator):
    assert calculator.multiply(3, 4) == 12

def test_divide(calculator):
    assert calculator.divide(10, 2) == 5

def test_divide_by_zero(calculator):
    with pytest.raises(ValueError):
        calculator.divide(10, 0)
```

### 2.2 æµ‹è¯•å¼‚æ­¥ä»£ç 

```python
# tests/test_async.py
import pytest
import asyncio
from app import AsyncService

@pytest.fixture
async def service():
    return await AsyncService.create()

@pytest.mark.asyncio
async def test_async_fetch(service):
    result = await service.fetch_data()
    assert result is not None

@pytest.mark.asyncio
async def test_async_with_timeout():
    async def slow_operation():
        await asyncio.sleep(5)
        return "done"

    result = await asyncio.wait_for(slow_operation(), timeout=1.0)
    # è¿™ä¼šè¶…æ—¶
```

### 2.3 Mocking

```python
# tests/test_with_mocks.py
import pytest
from unittest.mock import Mock, patch
from app import WeatherService

@pytest.fixture
def mock_api():
    with patch('app.WeatherService.api') as mock:
        mock.get_weather.return_value = {
            'temperature': 25,
            'condition': 'sunny'
        }
        return mock

def test_get_weather_with_mock(mock_api):
    service = WeatherService()
    weather = service.get_weather('Beijing')
    assert weather['temperature'] == 25
    mock_api.get_weather.assert_called_once_with('Beijing')

def test_mock_method_call():
    mock = Mock(return_value=42)
    result = mock('arg1', 'arg2')
    assert result == 42
    mock.assert_called_once_with('arg1', 'arg2')

def test_mock_attributes():
    mock = Mock()
    mock.configuration.get.return_value = 'test_value'
    assert mock.configuration.get('key') == 'test_value'
```

---

## 3. æµ‹è¯•æ›¿èº« (Test Doubles)

```python
from unittest.mock import Mock, MagicMock, patch, PropertyMock

# 1. Dummy - ç®€å•å ä½ï¼Œä¸ä½¿ç”¨
class Dummy:
    pass

def test_with_dummy():
    processor = Processor(Dummy())  # ä¸å…³å¿ƒè¿™ä¸ªå¯¹è±¡
    # ...

# 2. Stub - æä¾›é¢„è®¾å“åº”
class UserServiceStub:
    def get_user(self, id):
        return {'id': id, 'name': 'Test User'}

# 3. Spy - è®°å½•è°ƒç”¨ä¿¡æ¯
def test_with_spy():
    mock = Mock()
    mock.some_method('arg1')
    mock.some_method('arg2')

    assert mock.some_method.call_count == 2
    assert mock.some_method.call_args_list[0][0][0] == 'arg1'

# 4. Mock - é¢„è®¾æœŸæœ›
def test_with_mock():
    mock = Mock()
    mock.some_method.return_value = 'result'

    result = mock.some_method('arg')
    assert result == 'result'
    mock.some_method.assert_called_with('arg')

# 5. Fake - ç®€åŒ–å®ç°
class FakeUserRepository:
    def __init__(self):
        self.users = {'1': {'name': 'Alice'}}

    def get(self, id):
        return self.users.get(id)

    def save(self, user):
        self.users[user.id] = user
```

---

## 4. æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)

### 4.1 TDD å¾ªç¯ (Red-Green-Refactor)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TDD ä¸‰æ­¥å¾ªç¯                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. Red (å†™å¤±è´¥çš„æµ‹è¯•)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  def test_user_can_login():                     â”‚   â”‚
â”‚  â”‚      user = User(name='alice')                  â”‚   â”‚
â”‚  â”‚      assert user.login() == True                â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚  è¿è¡Œæµ‹è¯• â†’ âŒ å¤±è´¥ (ç±»ä¸å­˜åœ¨)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  2. Green (å†™æœ€å°‘ä»£ç è®©æµ‹è¯•é€šè¿‡)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  class User:                                    â”‚   â”‚
â”‚  â”‚      def login(self):                           â”‚   â”‚
â”‚  â”‚          return True                            â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚  è¿è¡Œæµ‹è¯• â†’ âœ… é€šè¿‡                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  3. Refactor (æ”¹è¿›ä»£ç )                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  class User:                                    â”‚   â”‚
â”‚  â”‚      def __init__(self, name):                  â”‚   â”‚
â”‚  â”‚          self.name = name                       â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚      def login(self):                           â”‚   â”‚
â”‚  â”‚          if not self.name:                      â”‚   â”‚
â”‚  â”‚              return False                       â”‚   â”‚
â”‚  â”‚          return True                            â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚  è¿è¡Œæµ‹è¯• â†’ âœ… é€šè¿‡                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  å¾ªç¯: Red â†’ Green â†’ Refactor â†’ Red â†’ ...              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 TDD ç¤ºä¾‹

```python
# ä»»åŠ¡: å®ç°ä¸€ä¸ªåä½œåè®®æ¶ˆæ¯å¤„ç†å™¨

# Step 1: å†™æµ‹è¯• (Red)
# tests/test_collaboration_protocol.py
import pytest
from app.protocol import CollaborationProtocol

def test_create_task_proposal():
    protocol = CollaborationProtocol()
    message = protocol.create_message(
        msg_type='task_proposal',
        from_id='user_a',
        to_id='user_b',
        payload={'title': 'å®Œæˆè®¾è®¡', 'priority': 'high'}
    )
    assert message['type'] == 'task_proposal'
    assert message['from'] == 'user_a'
    assert message['to'] == 'user_b'
    assert message['payload']['title'] == 'å®Œæˆè®¾è®¡'

def test_acknowledge_task():
    protocol = CollaborationProtocol()
    response = protocol.create_response(
        original_msg_id='msg_123',
        status='ack',
        estimated_completion='2026-02-01T18:00:00Z'
    )
    assert response['status'] == 'ack'
    assert response['original_proposal_id'] == 'msg_123'

def test_reject_task_with_reason():
    protocol = CollaborationProtocol()
    response = protocol.create_response(
        original_msg_id='msg_456',
        status='reject',
        reason='è´Ÿè·è¿‡è½½'
    )
    assert response['status'] == 'reject'
    assert response['reason'] == 'è´Ÿè·è¿‡è½½'

# Step 2: å†™å®ç° (Green)
# app/protocol.py
class CollaborationProtocol:
    def create_message(self, msg_type: str, from_id: str, to_id: str, payload: dict) -> dict:
        return {
            'msg_id': self._generate_id(),
            'type': msg_type,
            'from': from_id,
            'to': to_id,
            'payload': payload,
            'timestamp': self._timestamp()
        }

    def create_response(self, original_msg_id: str, status: str, **kwargs) -> dict:
        response = {
            'msg_id': self._generate_id(),
            'type': 'task_response',
            'original_proposal_id': original_msg_id,
            'status': status,
            'timestamp': self._timestamp()
        }
        if status == 'reject':
            response['reason'] = kwargs.get('reason', 'Unknown')
        if status in ('ack', 'negotiate'):
            response['estimated_completion'] = kwargs.get('estimated_completion')
        if status == 'negotiate':
            response['negotiation'] = {
                'suggested_deadline': kwargs.get('suggested_deadline'),
                'reason': kwargs.get('reason')
            }
        return response

    def _generate_id(self) -> str:
        import uuid
        return f"msg_{uuid.uuid4().hex[:8]}"

    def _timestamp(self) -> str:
        from datetime import datetime
        return datetime.utcnow().isoformat() + 'Z'
```

---

## 5. é›†æˆæµ‹è¯• (Integration Testing)

### 5.1 æ•°æ®åº“é›†æˆæµ‹è¯•

```python
# tests/conftest.py
import pytest
import asyncio
from app.database import init_db, get_pool

@pytest.fixture(scope='session')
def event_loop():
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()

@pytest.fixture(scope='session')
async def db_pool():
    pool = await init_db()
    yield pool
    await pool.close()

@pytest.fixture
async def clean_db(db_pool):
    # æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®
    async with db_pool.acquire() as conn:
        await conn.execute('DELETE FROM tasks')
        await conn.execute('DELETE FROM users')
    yield
    # æµ‹è¯•åæ¸…ç†
    async with db_pool.acquire() as conn:
        await conn.execute('DELETE FROM tasks')
        await conn.execute('DELETE FROM users')

# tests/test_tasks.py
import pytest
import pytest_asyncio
from app.models import Task, User

@pytest.mark.asyncio
async def test_create_and_retrieve_task(clean_db, db_pool):
    # åˆ›å»ºç”¨æˆ·
    user = await User.create(db_pool, name='Alice', email='alice@test.com')
    assert user.id is not None

    # åˆ›å»ºä»»åŠ¡
    task = await Task.create(
        db_pool,
        user_id=user.id,
        title='Test Task',
        priority='high'
    )
    assert task.id is not None

    # æŸ¥è¯¢ä»»åŠ¡
    retrieved = await Task.get_by_id(db_pool, task.id)
    assert retrieved.title == 'Test Task'
    assert retrieved.priority == 'high'

@pytest.mark.asyncio
async def test_task_status_transition(clean_db, db_pool):
    user = await User.create(db_pool, name='Bob', email='bob@test.com')
    task = await Task.create(db_pool, user_id=user.id, title='Task')

    # çŠ¶æ€è½¬æ¢
    await task.transition_to('pending')
    assert task.status == 'pending'

    await task.transition_to('in_progress')
    assert task.status == 'in_progress'

    await task.transition_to('completed')
    assert task.status == 'completed'

    # éªŒè¯çŠ¶æ€æœº
    from app.exceptions import InvalidStateTransition
    with pytest.raises(InvalidStateTransition):
        await task.transition_to('pending')  # ä¸èƒ½ä» completed å› pending
```

### 5.2 API é›†æˆæµ‹è¯•

```python
# tests/test_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app
from app.database import init_test_db

client = TestClient(app)

@pytest.fixture(autouse=True)
def setup_db():
    init_test_db()
    yield
    # æ¸…ç†

def test_health_check():
    response = client.get('/health')
    assert response.status_code == 200
    assert response.json() == {'status': 'healthy'}

def test_create_task():
    response = client.post('/api/v1/tasks', json={
        'title': 'Test Task',
        'priority': 'normal',
        'user_id': 'user_123'
    })
    assert response.status_code == 201
    data = response.json()
    assert data['title'] == 'Test Task'
    assert 'id' in data

def test_create_task_validation_error():
    response = client.post('/api/v1/tasks', json={
        'priority': 'invalid'  # æ— æ•ˆçš„ priority
    })
    assert response.status_code == 422  # Validation error

def test_list_tasks():
    # å…ˆåˆ›å»º
    client.post('/api/v1/tasks', json={'title': 'Task 1', 'user_id': 'u1'})
    client.post('/api/v1/tasks', json={'title': 'Task 2', 'user_id': 'u1'})

    # å†æŸ¥è¯¢
    response = client.get('/api/v1/tasks', params={'user_id': 'u1'})
    assert response.status_code == 200
    data = response.json()
    assert len(data) == 2

def test_get_nonexistent_task():
    response = client.get('/api/v1/tasks/nonexistent')
    assert response.status_code == 404
```

### 5.3 æœåŠ¡é›†æˆæµ‹è¯•

```python
# tests/test_services.py
import pytest
from unittest.mock import patch, MagicMock
from app.services import CollaborationService

class TestCollaborationService:
    @pytest.fixture
    def collab_service(self):
        return CollaborationService()

    def test_send_message_success(self, collab_service):
        # Mock å¤–éƒ¨ä¾èµ–
        with patch.object(collab_service, 'message_bus') as mock_bus:
            mock_bus.send.return_value = True

            result = collab_service.send_message(
                from_id='a',
                to_id='b',
                message={'type': 'task_proposal'}
            )

            assert result['success']
            mock_bus.send.assert_called_once()

    def test_send_message_failure(self, collab_service):
        with patch.object(collab_service, 'message_bus') as mock_bus:
            mock_bus.send.side_effect = ConnectionError('Connection failed')

            result = collab_service.send_message(
                from_id='a',
                to_id='b',
                message={'type': 'task_proposal'}
            )

            assert not result['success']
            assert 'error' in result

    def test_broadcast_to_multiple_recipients(self, collab_service):
        with patch.object(collab_service, 'message_bus') as mock_bus:
            mock_bus.send.return_value = True

            result = collab_service.broadcast(
                from_id='a',
                recipients=['b', 'c', 'd'],
                message={'type': 'announcement'}
            )

            assert mock_bus.send.call_count == 3
            assert result['success_count'] == 3
            assert result['failure_count'] == 0
```

---

## 6. ç«¯åˆ°ç«¯æµ‹è¯• (E2E Testing)

### 6.1 Playwright åŸºç¡€

```python
# tests/e2e/test_yoyoo.py
import pytest
from playwright.sync_api import sync_playwright

@pytest.fixture
def browser():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        yield browser
        browser.close()

@pytest.fixture
def page(browser):
    context = browser.new_context()
    page = context.new_page()
    yield page
    context.close()

def test_login_flow(page):
    # è®¿é—®ç™»å½•é¡µ
    page.goto('https://yoyoo.app/login')

    # è¾“å…¥å‡­æ®
    page.fill('input[name="email"]', 'test@example.com')
    page.fill('input[name="password"]', 'password123')

    # ç‚¹å‡»ç™»å½•
    page.click('button[type="submit"]')

    # éªŒè¯è·³è½¬
    page.wait_for_url('**/dashboard')
    assert 'Dashboard' in page.title()

def test_create_task(page):
    # ç™»å½•
    page.goto('https://yoyoo.app/login')
    page.fill('input[name="email"]', 'test@example.com')
    page.fill('input[name="password"]', 'password123')
    page.click('button[type="submit"]')
    page.wait_for_url('**/dashboard')

    # å¯¼èˆªåˆ°ä»»åŠ¡é¡µ
    page.click('text=Tasks')
    page.wait_for_url('**/tasks')

    # åˆ›å»ºä»»åŠ¡
    page.click('text=New Task')
    page.fill('input[name="title"]', 'E2E Test Task')
    page.fill('textarea[name="description"]', 'Testing E2E flow')
    page.select_option('select[name="priority"]', 'high')
    page.click('text=Create')

    # éªŒè¯åˆ›å»º
    page.wait_for_selector('text=E2E Test Task')
```

### 6.2 API E2E æµ‹è¯•

```python
# tests/e2e/test_collaboration.py
import pytest
import requests

BASE_URL = 'https://api.yoyoo.app/v1'

class TestCollaborationE2E:
    @pytest.fixture
    def auth_headers(self):
        # è·å– token (å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»ç™»å½•æµç¨‹è·å–)
        response = requests.post(f'{BASE_URL}/auth/login', json={
            'email': 'test@example.com',
            'password': 'password123'
        })
        token = response.json()['access_token']
        return {'Authorization': f'Bearer {token}'}

    def test_full_collaboration_flow(self, auth_headers):
        # Step 1: åˆ›å»ºä»»åŠ¡
        task_response = requests.post(
            f'{BASE_URL}/tasks',
            json={'title': 'åä½œåè®®è®¾è®¡', 'priority': 'high'},
            headers=auth_headers
        )
        assert task_response.status_code == 201
        task_id = task_response.json()['id']

        # Step 2: å‘é€åä½œæ¶ˆæ¯
        msg_response = requests.post(
            f'{BASE_URL}/collaboration/messages/send',
            json={
                'to_instance_id': 'instance_b',
                'type': 'task_proposal',
                'payload': {
                    'task_id': task_id,
                    'title': 'åä½œåè®®è®¾è®¡',
                    'due_at': '2026-02-03T18:00:00Z'
                }
            },
            headers=auth_headers
        )
        assert msg_response.status_code == 200
        msg_id = msg_response.json()['msg_id']

        # Step 3: æ¨¡æ‹Ÿå¯¹æ–¹å“åº” (ACK)
        # å®é™…åœºæ™¯ä¸­è¿™æ˜¯å¦ä¸€ä¸ªç”¨æˆ·çš„æ“ä½œ
        ack_response = requests.post(
            f'{BASE_URL}/collaboration/messages/{msg_id}/respond',
            json={'status': 'ack', 'estimated_completion': '2026-02-02T18:00:00Z'},
            headers=auth_headers
        )
        assert ack_response.status_code == 200

        # Step 4: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        task_response = requests.get(
            f'{BASE_URL}/tasks/{task_id}',
            headers=auth_headers
        )
        assert task_response.status_code == 200
        assert task_response.json()['status'] == 'accepted'

        # Step 5: æ›´æ–°è¿›åº¦
        update_response = requests.patch(
            f'{BASE_URL}/tasks/{task_id}/status',
            json={'status': 'in_progress'},
            headers=auth_headers
        )
        assert update_response.status_code == 200
```

---

## 7. æµ‹è¯•è¦†ç›–ç‡

### 7.1 é…ç½®è¦†ç›–ç‡

```ini
# pytest.ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --tb=short --cov=app --cov-report=html --cov-report=term-missing

[coverage:run]
source = app
omit =
    */__pycache__/*
    */tests/*
branch = True

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise NotImplementedError
```

### 7.2 è¿è¡Œè¦†ç›–ç‡

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest

# ç”Ÿæˆ HTML æŠ¥å‘Š
pytest --cov=app --cov-report=html
# æŸ¥çœ‹æŠ¥å‘Š
open htmlcov/index.html

# ç”Ÿæˆ XML æŠ¥å‘Š (CI)
pytest --cov=app --cov-report=xml
```

---

## 8. æµ‹è¯•æœ€ä½³å®è·µ

### 8.1 AAA æ¨¡å¼

```python
def test_calculate_total(self):
    # Arrange
    cart = ShoppingCart()
    item = Item(price=10, quantity=2)

    # Act
    cart.add(item)
    total = cart.calculate_total()

    # Assert
    assert total == 20
```

### 8.2 æµ‹è¯•æ›¿èº«åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä¸è¦ Mock ä½ æ‹¥æœ‰çš„ä¸œè¥¿** | ä¼˜å…ˆæµ‹è¯•çœŸå®äº¤äº’ | æµ‹è¯•æ•°æ®åº“ä»£ç ç”¨çœŸå® DB |
| **åª Mock å¤–éƒ¨ä¾èµ–** | HTTPã€æ–‡ä»¶ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹ API | Mock HTTP client |
| **ä¿æŒæµ‹è¯•ç®€å•** | ä¸€ä¸ªæµ‹è¯•ä¸€ä¸ªæ–­è¨€ | æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º |

### 8.3 æµ‹è¯•å‘½åè§„èŒƒ

```python
# âœ… å¥½çš„æµ‹è¯•å
def test_calculate_total_with_empty_cart_returns_zero():
    ...

def test_user_cannot_login_with_wrong_password():
    ...

def test_task_status_transition_from_pending_to_in_progress():
    ...

# âŒ é¿å…çš„æµ‹è¯•å
def test_calc():  # å¤ªæ¨¡ç³Š
def test_login():  # ä¸å®Œæ•´
def test_task():  # ä¸çŸ¥é“æµ‹ä»€ä¹ˆ
```

### 8.4 æµ‹è¯•æ•°æ®å·¥å‚

```python
# tests/factories.py
import factory
from app.models import User, Task

class UserFactory(factory.alchemy.SQLAlchemyModelFactory):
    class Meta:
        model = User

    name = factory.Faker('name')
    email = factory.LazyAttribute(lambda obj: f'{obj.name.lower().replace(" ", ".")}@test.com')
    plan = 'free'

class TaskFactory(factory.alchemy.SQLAlchemyModelFactory):
    class Meta:
        model = Task

    title = factory.Faker('sentence', nb_words=5)
    priority = 'normal'
    status = 'draft'
    user = factory.SubFactory(UserFactory)

# ä½¿ç”¨
def test_with_factory(db_session):
    task = TaskFactory()
    assert task.id is not None
    assert task.user.email.endswith('@test.com')
```

---

## 9. Yoyoo æµ‹è¯•ç­–ç•¥

### 9.1 æµ‹è¯•åˆ†å±‚

```
Yoyoo é¡¹ç›®æµ‹è¯•ç­–ç•¥/
â”œâ”€â”€ å•å…ƒæµ‹è¯• (70%)
â”‚   â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ services/         # ä¸šåŠ¡é€»è¾‘æµ‹è¯•
â”‚   â”œâ”€â”€ protocol/         # åè®®æµ‹è¯•
â”‚   â””â”€â”€ utils/            # å·¥å…·å‡½æ•°æµ‹è¯•
â”‚
â”œâ”€â”€ é›†æˆæµ‹è¯• (20%)
â”‚   â”œâ”€â”€ database/         # æ•°æ®åº“äº¤äº’æµ‹è¯•
â”‚   â”œâ”€â”€ api/              # API ç«¯ç‚¹æµ‹è¯•
â”‚   â””â”€â”€ services/         # æœåŠ¡é›†æˆæµ‹è¯•
â”‚
â””â”€â”€ E2E æµ‹è¯• (10%)
    â”œâ”€â”€ web/              # Web ç•Œé¢æµ‹è¯•
    â””â”€â”€ api/              # API å®Œæ•´æµç¨‹æµ‹è¯•
```

### 9.2 æµ‹è¯•ç¯å¢ƒ

```python
# tests/conftest.py
import pytest
import asyncio
from app.config import settings

@pytest.fixture(scope='session')
def event_loop():
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()

@pytest.fixture(scope='session')
def test_settings():
    return settings.testing()

@pytest.fixture
def db_session(test_settings):
    # ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
    from app.database import get_session
    return get_session(test_settings.test_db_url)

@pytest.fixture
def mock_openai():
    with patch('app.llm.client') as mock:
        mock.chat.completions.create.return_value = MagicMock(
            choices=[MagicMock(message=MagicMock(content='Mock response'))]
        )
        yield mock
```

### 9.3 CI/CD ä¸­çš„æµ‹è¯•

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: yoyoo_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run linter
        run: ruff check app/ tests/

      - name: Type check
        run: mypy app/

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/yoyoo_test
          OPENAI_API_KEY: mock
        run: pytest tests/ -v --cov=app --cov-report=xml

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/yoyoo_test
          OPENAI_API_KEY: mock
        run: pytest tests/integration/ -v

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
```

---

## 10. å­¦ä¹ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æµ‹è¯•é‡‘å­—å¡”**: 70% å•å…ƒæµ‹è¯• + 20% é›†æˆæµ‹è¯• + 10% E2E æµ‹è¯•
2. **TDD**: Red-Green-Refactor å¾ªç¯
3. **Mocking**: ä½¿ç”¨æµ‹è¯•æ›¿èº«éš”ç¦»å¤–éƒ¨ä¾èµ–
4. **AAA**: Arrange-Act-Assert æ¨¡å¼
5. **è¦†ç›–ç‡**: ç›®æ ‡æ˜¯ 80%+ è¦†ç›–ç‡ï¼Œé 100%

### Yoyoo æµ‹è¯•ç­–ç•¥

| å±‚çº§ | æµ‹è¯•å†…å®¹ | å·¥å…· |
|------|----------|------|
| å•å…ƒ | æ¨¡å‹ã€æœåŠ¡ã€åè®® | pytest |
| é›†æˆ | æ•°æ®åº“ã€APIã€æœåŠ¡äº¤äº’ | pytest-asyncio |
| E2E | ç”¨æˆ·æµç¨‹ã€å®Œæ•´åä½œ | Playwright |

### æµ‹è¯•åŸåˆ™

- æµ‹è¯•åº”è¯¥æ˜¯å¯é çš„ (deterministic)
- æµ‹è¯•åº”è¯¥æ˜¯å¿«é€Ÿçš„ (fast)
- æµ‹è¯•åº”è¯¥æ˜¯ç‹¬ç«‹çš„ (isolated)
- æµ‹è¯•åº”è¯¥æ˜¯å¯ç»´æŠ¤çš„ (maintainable)

---

## å‚è€ƒèµ„æº

- [pytest æ–‡æ¡£](https://docs.pytest.org/)
- [pytest-asyncio](https://pytest-asyncio.readthedocs.io/)
- [Playwright Python](https://playwright.dev/python/)
- [TDD å…¥é—¨](https://testdriven.io/blog/test-driven-development/)
- [æµ‹è¯•é‡‘å­—å¡”](https://martinfowler.com/articles/practical-test-pyramid.html)
